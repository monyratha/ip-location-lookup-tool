{% extends 'base.html' %}
{% block title %}IP Cache{% endblock %}
{% block extra_head %}
<style>
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .header { display: flex; justify-content: space-between; align-items: center; }
    .search { margin: 20px 0; display: flex; gap: 5px; flex-wrap: wrap; }
    .search input, .search select { padding: 8px; }
    .search button { padding: 8px 15px; background: #007cba; color: white; border: none; cursor: pointer; }
    .delete-btn { background: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; }
    .delete-btn:hover { background: #c82333; }
    .pagination { margin: 20px 0; text-align: center; }
    .pagination a, .pagination span { padding: 8px 12px; margin: 0 2px; text-decoration: none; border: 1px solid #ddd; }
    .pagination .current { background: #007cba; color: white; }
    a { color: #007cba; text-decoration: none; }
    a:hover { text-decoration: underline; }
</style>
{% endblock %}
{% block content %}
<div class="header">
    <h1>üóÑÔ∏è IP Cache ({{ total }} records)</h1>
</div>

<div class="search">
    <form method="GET">
        <input type="text" name="search" value="{{ search }}" placeholder="Search...">
        <select name="country">
            <option value="">All Countries</option>
            {% for c in countries %}
                <option value="{{ c }}" {% if c == country_filter %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>
        <select name="region">
            <option value="">All Regions</option>
            {% for r in regions %}
                <option value="{{ r }}" {% if r == region_filter %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
        </select>
        <select name="city">
            <option value="">All Cities</option>
            {% for c in cities %}
                <option value="{{ c }}" {% if c == city_filter %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>
        <button type="submit">Filter</button>
        {% if search or country_filter or region_filter or city_filter %}<a href="/cache">Clear</a>{% endif %}
    </form>
</div>

<table>
    <thead>
        <tr>
            <th>IP Address</th>
            <th>Country</th>
            <th>Region</th>
            <th>City</th>
            <th>ISP</th>
            <th>Timezone</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for row in cache_data %}
        <tr>
            <td>{{ row['ip'] }}</td>
            <td>{{ row['country'] }}</td>
            <td>{{ row['region'] }}</td>
            <td>{{ row['city'] }}</td>
            <td>{{ row['isp'] }}</td>
            <td>{{ row['timezone'] }}</td>
            <td><button class="delete-btn" onclick="deleteIP('{{ row['ip'] }}')">Delete</button></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="pagination">
    {% if page > 1 %}
        <a href="?page=1{% if search %}&search={{ search }}{% endif %}">&laquo; First</a>
        <a href="?page={{ page-1 }}{% if search %}&search={{ search }}{% endif %}">&lsaquo; Prev</a>
    {% endif %}

    {% for p in page_range %}
        {% if p == page %}
            <span class="current">{{ p }}</span>
        {% else %}
            <a href="?page={{ p }}{% if search %}&search={{ search }}{% endif %}">{{ p }}</a>
        {% endif %}
    {% endfor %}

    {% if page < total_pages %}
        <a href="?page={{ page+1 }}{% if search %}&search={{ search }}{% endif %}">Next &rsaquo;</a>
        <a href="?page={{ total_pages }}{% if search %}&search={{ search }}{% endif %}">Last &raquo;</a>
    {% endif %}
</div>

<p><em>Showing {{ cache_data|length }} of {{ total }} records (Page {{ page }} of {{ total_pages }})</em></p>
<script>
    async function deleteIP(ip) {
        if (!confirm(`Delete cached data for ${ip}?`)) return;
        try {
            const response = await fetch(`/delete-cache/${ip}`, {method: 'POST'});
            if (response.ok) {
                location.reload();
            } else {
                const data = await response.json();
                alert(`Error: ${data.error}`);
            }
        } catch (err) {
            alert(`Error: ${err.message}`);
        }
    }
</script>
{% endblock %}
