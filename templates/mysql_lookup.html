{% extends 'base.html' %}
{% block title %}MySQL Table Lookup{% endblock %}
{% block content %}
<h1 class="mb-4">üîç MySQL Table Lookup</h1>
<div class="card p-4 shadow-sm">
    {% if mysql_connections %}
    <p>Select a connection and table to fetch unique IPs with location data.</p>
    <div class="row g-3 mb-2">
        <div class="col-md-3">
            <label class="form-label">Connection</label>
            <select id="mysqlConn" class="form-select">
                {% for c in mysql_connections %}
                    <option value="{{ c['id'] }}">{{ c['name'] }} ({{ c['database'] }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Table</label>
            <input type="text" id="mysqlTable" class="form-control" placeholder="Table name">
        </div>
        <div class="col-md-2">
            <label class="form-label">IP column</label>
            <input type="text" id="mysqlIpCol" class="form-control" value="client_ip">
        </div>
        <div class="col-md-2">
            <label class="form-label">Start time</label>
            <input type="datetime-local" id="mysqlStart" class="form-control">
        </div>
        <div class="col-md-2">
            <label class="form-label">End time</label>
            <input type="datetime-local" id="mysqlEnd" class="form-control">
        </div>
    </div>
    <div class="row g-2 mb-2">
        <div class="col-md-2 ms-auto">
            <button class="btn btn-primary w-100" onclick="fetchMySQL()">Fetch</button>
        </div>
    </div>
    <div id="mysqlProgress" class="mt-2"></div>
    {% else %}
    <p>No MySQL connections configured. <a href="{{ url_for('manage_connections') }}">Add one</a>.</p>
    {% endif %}
</div>
<script>
async function fetchMySQL() {
    const conn = document.getElementById('mysqlConn').value;
    const table = document.getElementById('mysqlTable').value;
    const col = document.getElementById('mysqlIpCol').value || 'client_ip';
    const start = document.getElementById('mysqlStart').value;
    const end = document.getElementById('mysqlEnd').value;
    if (!conn || !table) return;

    const progress = document.getElementById('mysqlProgress');
    progress.textContent = 'Starting...';

    const response = await fetch('/fetch-mysql', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            connection_id: conn,
            table: table,
            ip_column: col,
            start_time: start ? start.replace('T', ' ') + ':00' : null,
            end_time: end ? end.replace('T', ' ') + ':00' : null
        })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    while (true) {
        const {done, value} = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, {stream:true});
        const lines = buffer.split('\n');
        buffer = lines.pop();
        for (const line of lines) {
            if (line.startsWith('data: ')) {
                const data = JSON.parse(line.slice(6));
                if (data.type === 'progress') {
                    progress.textContent = `${data.processed}/${data.total} IPs processed`;
                } else if (data.type === 'complete') {
                    progress.innerHTML = `Done! <a href="/view/${data.filename}">${data.filename}</a>`;
                } else if (data.type === 'error') {
                    progress.textContent = `Error: ${data.message}`;
                }
            }
        }
    }
}
</script>
{% endblock %}
